name: CI

on: push

jobs:

  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - name: Build Universal Binary
      run: ./build-macos.sh
        
    - name: Test Binaries
      run: |
        # Test if binaries exist and are universal
        cd sox-build/universal/bin
        
        # Check if binaries exist
        for binary in sox soxi play rec; do
          if [ ! -f "$binary" ]; then
            echo "Error: $binary not found"
            exit 1
          fi
          
          # Check if binary is universal
          if ! lipo -info "$binary" | grep -q "x86_64" || ! lipo -info "$binary" | grep -q "arm64"; then
            echo "Error: $binary is not a universal binary"
            exit 1
          fi
        done
        
        # Test basic functionality
        ./sox --version
        
        # Create a test file and process it
        ./sox -n test.wav synth 3 sine 440
        ./soxi test.wav

    - name: Upload Binaries
      uses: actions/upload-artifact@v4
      with:
        name: sox-macos-universal
        path: sox-build/universal/bin/*
        if-no-files-found: error



  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config curl xz-utils

      - name: Build Linux (x64)
        run: chmod +x build-linux.sh && ./build-linux.sh

      - name: Test binaries
        working-directory: sox-build/linux-x86_64/bin
        run: |
          ./sox --version
          ./sox -n test.wav synth 1 sine 440
          ./soxi test.wav

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sox-linux-x64
          path: sox-build/linux-x86_64/bin/*
          if-no-files-found: error



  build-linux-arm64:
    runs-on: ubuntu-22.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config curl xz-utils

      - name: Build Linux (arm64)
        run: chmod +x build-linux-arm64.sh && ./build-linux-arm64.sh

      - name: Test binaries
        working-directory: sox-build/linux-aarch64/bin
        run: |
          ./sox --version
          ./sox -n test.wav synth 1 sine 440
          ./soxi test.wav

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sox-linux-arm64
          path: sox-build/linux-aarch64/bin/*
          if-no-files-found: error